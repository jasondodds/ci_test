@isTest
private class GithubServiceTest {
    
    public static testMethod void oauth_redirect_test() {
        //////////////////////////////////////////////
        //// test calling the UserSetupController ////
        //// init method, calling GitHubService //////
        //////////////////////////////////////////////

        TestFactory.factoryOauthSetting(true);

        test.startTest();
        UserSetupController usc = new UserSetupController();
        PageReference ref = usc.githubOauth();
        Code_Accelerator_Setting__mdt oauth = [SELECT CS_GitHub_Client_Id__c, CS_GitHub_Client_Secret__c FROM Code_Accelerator_Setting__mdt WHERE MasterLabel = 'Integration Setting' LIMIT 1];
        
        system.assertEquals('https://github.com/login/oauth/authorize?client_id='+oauth.CS_GitHub_Client_Id__c+'&redirect_uri=codescience.com&scope=repo', ref.getUrl());
        test.stopTest();
    }
    
    public static testMethod void create_oauth_settings_valid_test() {
        //////////////////////////////////////////////x
        //// test calling the UserSetupController ////
        //// init method, calling GitHubService to////
        //// get 
        //////////////////////////////////////////////

        String orgResp = '[{"login": "github","id": 1,"url": "https://api.github.com/orgs/github","avatar_url": "https://github.com/images/error/octocat_happy.gif","description": "A great organization"}]';
        Test.setMock(HttpCalloutMock.class, new GithubCalloutMock(orgResp));

        Test.setCurrentPageReference(Page.UserSetup); 
        System.currentPageReference().getParameters().put('code', '12345');

        test.startTest();
        UserSetupController usc = new UserSetupController();
        usc.init();
        UserDefinition__c ud = UserDefinition__c.getInstance(UserInfo.getUserId());
        system.assertEquals(ud.VCS_Token__c, 'e72e16c7e42f292c6912e7710c838347ae178b4a');
        test.stopTest();
    }
    
    public static testMethod void create_oauth_settings_invalid_test() {
        //////////////////////////////////////////////x
        //// test calling the UserSetupController ////
        //// init method, calling GitHubService //////
        //////////////////////////////////////////////

        String orgResp = '[]';
        Test.setMock(HttpCalloutMock.class, new GithubCalloutMock(orgResp));

        Test.setCurrentPageReference(Page.UserSetup); 
        System.currentPageReference().getParameters().put('code', '12345');

        test.startTest();
        UserSetupController usc = new UserSetupController();
        usc.init();
        UserDefinition__c ud = UserDefinition__c.getInstance(UserInfo.getUserId());
        system.assertEquals(ud.VCS_Token__c, null);
        test.stopTest();
    }

    public static testMethod void create_repo_valid_test() {

        String orgResp = '{"id":44010687,"name":"testRepo","full_name":"CodeScience/testRepo","owner":{"login":"CodeScience","id":5943746,"avatar_url":"https://avatars.githubusercontent.com/u/5943746?v=3","gravatar_id":"","url":"https://api.github.com/users/CodeScience","html_url":"https://github.com/CodeScience","followers_url":"https://api.github.com/users/CodeScience/followers","following_url":"https://api.github.com/users/CodeScience/following{/other_user}","gists_url":"https://api.github.com/users/CodeScience/gists{/gist_id}","starred_url":"https://api.github.com/users/CodeScience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CodeScience/subscriptions","organizations_url":"https://api.github.com/users/CodeScience/orgs","repos_url":"https://api.github.com/users/CodeScience/repos","events_url":"https://api.github.com/users/CodeScience/events{/privacy}","received_events_url":"https://api.github.com/users/CodeScience/received_events","type":"Organization","site_admin":false},"private":true,"html_url":"https://github.com/CodeScience/testRepo","description":null,"fork":false,"url":"https://api.github.com/repos/CodeScience/testRepo","forks_url":"https://api.github.com/repos/CodeScience/testRepo/forks","keys_url":"https://api.github.com/repos/CodeScience/testRepo/keys{/key_id}","collaborators_url":"https://api.github.com/repos/CodeScience/testRepo/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/CodeScience/testRepo/teams","hooks_url":"https://api.github.com/repos/CodeScience/testRepo/hooks","issue_events_url":"https://api.github.com/repos/CodeScience/testRepo/issues/events{/number}","events_url":"https://api.github.com/repos/CodeScience/testRepo/events","assignees_url":"https://api.github.com/repos/CodeScience/testRepo/assignees{/user}","branches_url":"https://api.github.com/repos/CodeScience/testRepo/branches{/branch}","tags_url":"https://api.github.com/repos/CodeScience/testRepo/tags","blobs_url":"https://api.github.com/repos/CodeScience/testRepo/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/CodeScience/testRepo/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/CodeScience/testRepo/git/refs{/sha}","trees_url":"https://api.github.com/repos/CodeScience/testRepo/git/trees{/sha}","statuses_url":"https://api.github.com/repos/CodeScience/testRepo/statuses/{sha}","languages_url":"https://api.github.com/repos/CodeScience/testRepo/languages","stargazers_url":"https://api.github.com/repos/CodeScience/testRepo/stargazers","contributors_url":"https://api.github.com/repos/CodeScience/testRepo/contributors","subscribers_url":"https://api.github.com/repos/CodeScience/testRepo/subscribers","subscription_url":"https://api.github.com/repos/CodeScience/testRepo/subscription","commits_url":"https://api.github.com/repos/CodeScience/testRepo/commits{/sha}","git_commits_url":"https://api.github.com/repos/CodeScience/testRepo/git/commits{/sha}","comments_url":"https://api.github.com/repos/CodeScience/testRepo/comments{/number}","issue_comment_url":"https://api.github.com/repos/CodeScience/testRepo/issues/comments{/number}","contents_url":"https://api.github.com/repos/CodeScience/testRepo/contents/{+path}","compare_url":"https://api.github.com/repos/CodeScience/testRepo/compare/{base}...{head}","merges_url":"https://api.github.com/repos/CodeScience/testRepo/merges","archive_url":"https://api.github.com/repos/CodeScience/testRepo/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/CodeScience/testRepo/downloads","issues_url":"https://api.github.com/repos/CodeScience/testRepo/issues{/number}","pulls_url":"https://api.github.com/repos/CodeScience/testRepo/pulls{/number}","milestones_url":"https://api.github.com/repos/CodeScience/testRepo/milestones{/number}","notifications_url":"https://api.github.com/repos/CodeScience/testRepo/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/CodeScience/testRepo/labels{/name}","releases_url":"https://api.github.com/repos/CodeScience/testRepo/releases{/id}","created_at":"2015-10-10T12:58:02Z","updated_at":"2015-10-10T12:58:02Z","pushed_at":"2015-10-10T12:58:02Z","git_url":"git://github.com/CodeScience/testRepo.git","ssh_url":"git@github.com:CodeScience/testRepo.git","clone_url":"https://github.com/CodeScience/testRepo.git","svn_url":"https://github.com/CodeScience/testRepo","homepage":null,"size":0,"stargazers_count":0,"watchers_count":0,"language":null,"has_issues":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"forks_count":0,"mirror_url":null,"open_issues_count":0,"forks":0,"open_issues":0,"watchers":0,"default_branch":"master","permissions":{"admin":true,"push":true,"pull":true},"organization":{"login":"CodeScience","id":5943746,"avatar_url":"https://avatars.githubusercontent.com/u/5943746?v=3","gravatar_id":"","url":"https://api.github.com/users/CodeScience","html_url":"https://github.com/CodeScience","followers_url":"https://api.github.com/users/CodeScience/followers","following_url":"https://api.github.com/users/CodeScience/following{/other_user}","gists_url":"https://api.github.com/users/CodeScience/gists{/gist_id}","starred_url":"https://api.github.com/users/CodeScience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CodeScience/subscriptions","organizations_url":"https://api.github.com/users/CodeScience/orgs","repos_url":"https://api.github.com/users/CodeScience/repos","events_url":"https://api.github.com/users/CodeScience/events{/privacy}","received_events_url":"https://api.github.com/users/CodeScience/received_events","type":"Organization","site_admin":false},"network_count":0,"subscribers_count":6}';
        Test.setMock(HttpCalloutMock.class, new GithubCalloutMock(orgResp));

        ProjectDefinition__c projectDefinition = TestFactory.factoryProjectDefinition(true);

        test.startTest();
        String response = GitHubService.createRepoFromProjectDefinition(projectDefinition);
        System.assert(response != null, 'The mock should return a response');
        projectDefinition = [SELECT Repo_Name__c, Repo_Url__c FROM ProjectDefinition__c WHERE Id = :projectDefinition.Id LIMIT 1];
        System.assert(projectDefinition.Repo_Name__c == 'CodeScience/Test-Project', 'The repo name should have been saved');
        System.assert(projectDefinition.Repo_Url__c == 'https://github.com/CodeScience/Test-Project', 'The repo URL should have been saved');
        test.stopTest();
    }

    public static testMethod void add_collaborators() {

        String orgResp = '{"id":44010687,"name":"testRepo","full_name":"CodeScience/testRepo","owner":{"login":"CodeScience","id":5943746,"avatar_url":"https://avatars.githubusercontent.com/u/5943746?v=3","gravatar_id":"","url":"https://api.github.com/users/CodeScience","html_url":"https://github.com/CodeScience","followers_url":"https://api.github.com/users/CodeScience/followers","following_url":"https://api.github.com/users/CodeScience/following{/other_user}","gists_url":"https://api.github.com/users/CodeScience/gists{/gist_id}","starred_url":"https://api.github.com/users/CodeScience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CodeScience/subscriptions","organizations_url":"https://api.github.com/users/CodeScience/orgs","repos_url":"https://api.github.com/users/CodeScience/repos","events_url":"https://api.github.com/users/CodeScience/events{/privacy}","received_events_url":"https://api.github.com/users/CodeScience/received_events","type":"Organization","site_admin":false},"private":true,"html_url":"https://github.com/CodeScience/testRepo","description":null,"fork":false,"url":"https://api.github.com/repos/CodeScience/testRepo","forks_url":"https://api.github.com/repos/CodeScience/testRepo/forks","keys_url":"https://api.github.com/repos/CodeScience/testRepo/keys{/key_id}","collaborators_url":"https://api.github.com/repos/CodeScience/testRepo/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/CodeScience/testRepo/teams","hooks_url":"https://api.github.com/repos/CodeScience/testRepo/hooks","issue_events_url":"https://api.github.com/repos/CodeScience/testRepo/issues/events{/number}","events_url":"https://api.github.com/repos/CodeScience/testRepo/events","assignees_url":"https://api.github.com/repos/CodeScience/testRepo/assignees{/user}","branches_url":"https://api.github.com/repos/CodeScience/testRepo/branches{/branch}","tags_url":"https://api.github.com/repos/CodeScience/testRepo/tags","blobs_url":"https://api.github.com/repos/CodeScience/testRepo/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/CodeScience/testRepo/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/CodeScience/testRepo/git/refs{/sha}","trees_url":"https://api.github.com/repos/CodeScience/testRepo/git/trees{/sha}","statuses_url":"https://api.github.com/repos/CodeScience/testRepo/statuses/{sha}","languages_url":"https://api.github.com/repos/CodeScience/testRepo/languages","stargazers_url":"https://api.github.com/repos/CodeScience/testRepo/stargazers","contributors_url":"https://api.github.com/repos/CodeScience/testRepo/contributors","subscribers_url":"https://api.github.com/repos/CodeScience/testRepo/subscribers","subscription_url":"https://api.github.com/repos/CodeScience/testRepo/subscription","commits_url":"https://api.github.com/repos/CodeScience/testRepo/commits{/sha}","git_commits_url":"https://api.github.com/repos/CodeScience/testRepo/git/commits{/sha}","comments_url":"https://api.github.com/repos/CodeScience/testRepo/comments{/number}","issue_comment_url":"https://api.github.com/repos/CodeScience/testRepo/issues/comments{/number}","contents_url":"https://api.github.com/repos/CodeScience/testRepo/contents/{+path}","compare_url":"https://api.github.com/repos/CodeScience/testRepo/compare/{base}...{head}","merges_url":"https://api.github.com/repos/CodeScience/testRepo/merges","archive_url":"https://api.github.com/repos/CodeScience/testRepo/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/CodeScience/testRepo/downloads","issues_url":"https://api.github.com/repos/CodeScience/testRepo/issues{/number}","pulls_url":"https://api.github.com/repos/CodeScience/testRepo/pulls{/number}","milestones_url":"https://api.github.com/repos/CodeScience/testRepo/milestones{/number}","notifications_url":"https://api.github.com/repos/CodeScience/testRepo/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/CodeScience/testRepo/labels{/name}","releases_url":"https://api.github.com/repos/CodeScience/testRepo/releases{/id}","created_at":"2015-10-10T12:58:02Z","updated_at":"2015-10-10T12:58:02Z","pushed_at":"2015-10-10T12:58:02Z","git_url":"git://github.com/CodeScience/testRepo.git","ssh_url":"git@github.com:CodeScience/testRepo.git","clone_url":"https://github.com/CodeScience/testRepo.git","svn_url":"https://github.com/CodeScience/testRepo","homepage":null,"size":0,"stargazers_count":0,"watchers_count":0,"language":null,"has_issues":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"forks_count":0,"mirror_url":null,"open_issues_count":0,"forks":0,"open_issues":0,"watchers":0,"default_branch":"master","permissions":{"admin":true,"push":true,"pull":true},"organization":{"login":"CodeScience","id":5943746,"avatar_url":"https://avatars.githubusercontent.com/u/5943746?v=3","gravatar_id":"","url":"https://api.github.com/users/CodeScience","html_url":"https://github.com/CodeScience","followers_url":"https://api.github.com/users/CodeScience/followers","following_url":"https://api.github.com/users/CodeScience/following{/other_user}","gists_url":"https://api.github.com/users/CodeScience/gists{/gist_id}","starred_url":"https://api.github.com/users/CodeScience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CodeScience/subscriptions","organizations_url":"https://api.github.com/users/CodeScience/orgs","repos_url":"https://api.github.com/users/CodeScience/repos","events_url":"https://api.github.com/users/CodeScience/events{/privacy}","received_events_url":"https://api.github.com/users/CodeScience/received_events","type":"Organization","site_admin":false},"network_count":0,"subscribers_count":6}';
        Test.setMock(HttpCalloutMock.class, new GithubCalloutMock(orgResp));

        ProjectDefinition__c projectDefinition = TestFactory.factoryProjectDefinition(true);
        List<Team_Member__c> teamMembers = TestFactory.factoryTeamMembers(true, projectDefinition, 2);
    }

    public static testMethod void test_remove_team_members_success() {
        String orgResp = '{"id":44010687,"name":"testRepo","full_name":"CodeScience/testRepo","owner":{"login":"CodeScience","id":5943746,"avatar_url":"https://avatars.githubusercontent.com/u/5943746?v=3","gravatar_id":"","url":"https://api.github.com/users/CodeScience","html_url":"https://github.com/CodeScience","followers_url":"https://api.github.com/users/CodeScience/followers","following_url":"https://api.github.com/users/CodeScience/following{/other_user}","gists_url":"https://api.github.com/users/CodeScience/gists{/gist_id}","starred_url":"https://api.github.com/users/CodeScience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CodeScience/subscriptions","organizations_url":"https://api.github.com/users/CodeScience/orgs","repos_url":"https://api.github.com/users/CodeScience/repos","events_url":"https://api.github.com/users/CodeScience/events{/privacy}","received_events_url":"https://api.github.com/users/CodeScience/received_events","type":"Organization","site_admin":false},"private":true,"html_url":"https://github.com/CodeScience/testRepo","description":null,"fork":false,"url":"https://api.github.com/repos/CodeScience/testRepo","forks_url":"https://api.github.com/repos/CodeScience/testRepo/forks","keys_url":"https://api.github.com/repos/CodeScience/testRepo/keys{/key_id}","collaborators_url":"https://api.github.com/repos/CodeScience/testRepo/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/CodeScience/testRepo/teams","hooks_url":"https://api.github.com/repos/CodeScience/testRepo/hooks","issue_events_url":"https://api.github.com/repos/CodeScience/testRepo/issues/events{/number}","events_url":"https://api.github.com/repos/CodeScience/testRepo/events","assignees_url":"https://api.github.com/repos/CodeScience/testRepo/assignees{/user}","branches_url":"https://api.github.com/repos/CodeScience/testRepo/branches{/branch}","tags_url":"https://api.github.com/repos/CodeScience/testRepo/tags","blobs_url":"https://api.github.com/repos/CodeScience/testRepo/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/CodeScience/testRepo/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/CodeScience/testRepo/git/refs{/sha}","trees_url":"https://api.github.com/repos/CodeScience/testRepo/git/trees{/sha}","statuses_url":"https://api.github.com/repos/CodeScience/testRepo/statuses/{sha}","languages_url":"https://api.github.com/repos/CodeScience/testRepo/languages","stargazers_url":"https://api.github.com/repos/CodeScience/testRepo/stargazers","contributors_url":"https://api.github.com/repos/CodeScience/testRepo/contributors","subscribers_url":"https://api.github.com/repos/CodeScience/testRepo/subscribers","subscription_url":"https://api.github.com/repos/CodeScience/testRepo/subscription","commits_url":"https://api.github.com/repos/CodeScience/testRepo/commits{/sha}","git_commits_url":"https://api.github.com/repos/CodeScience/testRepo/git/commits{/sha}","comments_url":"https://api.github.com/repos/CodeScience/testRepo/comments{/number}","issue_comment_url":"https://api.github.com/repos/CodeScience/testRepo/issues/comments{/number}","contents_url":"https://api.github.com/repos/CodeScience/testRepo/contents/{+path}","compare_url":"https://api.github.com/repos/CodeScience/testRepo/compare/{base}...{head}","merges_url":"https://api.github.com/repos/CodeScience/testRepo/merges","archive_url":"https://api.github.com/repos/CodeScience/testRepo/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/CodeScience/testRepo/downloads","issues_url":"https://api.github.com/repos/CodeScience/testRepo/issues{/number}","pulls_url":"https://api.github.com/repos/CodeScience/testRepo/pulls{/number}","milestones_url":"https://api.github.com/repos/CodeScience/testRepo/milestones{/number}","notifications_url":"https://api.github.com/repos/CodeScience/testRepo/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/CodeScience/testRepo/labels{/name}","releases_url":"https://api.github.com/repos/CodeScience/testRepo/releases{/id}","created_at":"2015-10-10T12:58:02Z","updated_at":"2015-10-10T12:58:02Z","pushed_at":"2015-10-10T12:58:02Z","git_url":"git://github.com/CodeScience/testRepo.git","ssh_url":"git@github.com:CodeScience/testRepo.git","clone_url":"https://github.com/CodeScience/testRepo.git","svn_url":"https://github.com/CodeScience/testRepo","homepage":null,"size":0,"stargazers_count":0,"watchers_count":0,"language":null,"has_issues":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"forks_count":0,"mirror_url":null,"open_issues_count":0,"forks":0,"open_issues":0,"watchers":0,"default_branch":"master","permissions":{"admin":true,"push":true,"pull":true},"organization":{"login":"CodeScience","id":5943746,"avatar_url":"https://avatars.githubusercontent.com/u/5943746?v=3","gravatar_id":"","url":"https://api.github.com/users/CodeScience","html_url":"https://github.com/CodeScience","followers_url":"https://api.github.com/users/CodeScience/followers","following_url":"https://api.github.com/users/CodeScience/following{/other_user}","gists_url":"https://api.github.com/users/CodeScience/gists{/gist_id}","starred_url":"https://api.github.com/users/CodeScience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CodeScience/subscriptions","organizations_url":"https://api.github.com/users/CodeScience/orgs","repos_url":"https://api.github.com/users/CodeScience/repos","events_url":"https://api.github.com/users/CodeScience/events{/privacy}","received_events_url":"https://api.github.com/users/CodeScience/received_events","type":"Organization","site_admin":false},"network_count":0,"subscribers_count":6}';
        Test.setMock(HttpCalloutMock.class, new GithubCalloutMock(orgResp));
        ProjectDefinition__c projectDefinition = TestFactory.factoryProjectDefinition(true);
        Team_Member__c member1 = TestFactory.factoryTeamMember(true, projectDefinition, null, null, null);
        test.startTest();
            delete member1;
        test.stopTest();
    }

    public static testMethod void test_getOrgMembers(){
        String orgResp = '[{"login":"abhinavguptas","type":"User","site_admin":false},{"login":"akomara","type":"User","site_admin":false}]';
        Test.setMock(HttpCalloutMock.class, new GithubCalloutMock(orgResp));
        Test.startTest();
            List<String> orgMembers = GithubService.getOrgMembers(null,'CodeScience');
            System.assert(orgMembers.size() == 2, 'There should be two members in the org');
        Test.stopTest();
    }
    
    public static testMethod void test_getErrorString() {
       String response = '{"message":"Validation Failed","errors":[{"resource":"Repository","code":"custom","field":"name","message":"name already exists on this account"}],"documentation_url":"https://developer.github.com/v3/repos/#create"}';
       String errorMessage = GithubService.getErrorString(response);
       system.assert(errorMessage == 'Validation Failed - name already exists on this account', 'The error message should be parsed, but it was: '+errorMessage);
    }
}